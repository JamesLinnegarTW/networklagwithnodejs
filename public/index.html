<!DOCTYPE html>
<html>
	<head>
		<title>PacketLossTest</title>
		  <style>
		  	#ball {
		  		position:fixed;
		  		left:0;
		  		top:100px;
		  		width:20px;
		  		height:20px;
		  		background-color:red;
		  		z-index:10;
		  	}
		  	</style>
	</head>
	<body>


	<div id="debug"></div>
	<div id="ball"></div>
	<script src='js/socket.io.js'></script> 
	<script src='js/underscore.js'></script> 
	<script src='js/animationFrameShim.js'></script> 
	
	<script type="text/javascript">

		var W = window.innerWidth;
	
       window.onresize = function(){
               W = window.innerWidth;               
       };

	(function(){
		var worldBuffer = [];
	    var worldBufferIndex = -1;
	    var serverTick;
	    var el = document.getElementById('debug');	   
	    var bEl = document.getElementById('ball');
	    var firstTick;
	    var firstTickTime;

		var socket = io.connect(
			'http://'+window.location.hostname+':9000/'
		);

		socket.on('w', function(data){
			serverTick = data.tick;
			worldBufferIndex++;

			if(worldBufferIndex > 30){
				worldBufferIndex = 0;
			}

			worldBuffer[worldBufferIndex] = data;
			
			if(!firstTick) {
				firstTick = data.tick;
				firstTickTime = new Date().getTime().toString().substring(0,11);
				requestAnimationFrame(start);
			}
			
		});

		function start(){
			var toRender = null;
			var sortedBuffer = _.sort(worldBuffer, function(state){ return state.tick; });

			var currentTime = new Date().getTime().toString().substring(0,11);
			var timeSincefirstTick = ((currentTime - 10) - firstTickTime); 
			var tickNo = Math.floor((timeSincefirstTick) + firstTick);
			
			if(tickNo > serverTick) tickNo = serverTick;
			toRender = _.find(sortedBuffer, function(world){ return world.tick == tickNo; });
			
			if(toRender) {
				toRender.rendered = true;
				bEl.style.left = ((toRender.b.x / 100) * 1000) + "px";				
			}
						
			requestAnimationFrame(start);
		}

	})();

	</script>
	</body>
</html>
