<!DOCTYPE html>
<html>
	<head>
		<title>PacketLossTest</title>
		  	<meta name="viewport" content = "width = device-width, initial-scale = 1, user-scalable = no" />
		  	<meta name="apple-mobile-web-app-capable" content="yes" />
		  <style>
		  	#ball {
		  		position:fixed;
		  		left:0;
		  		top:100px;
		  		width:20px;
		  		height:20px;
		  		background-color:red;
		  		z-index:10;
		  	}
		  	</style>
	</head>
	<body>


	<div id="debug"></div>
	<div id="ball"></div>
	<script src='js/socket.io.js'></script> 
	<script src='js/underscore.js'></script> 
	<script src='js/animationFrameShim.js'></script> 
	<script src='http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v1.3.0.js'></script>
	
<script id="entry-template" type="text/x-handlebars-template">
<h4>{{debug}}</h4>

  {{#each buffer}}
  	<div>
  	{{#if rendered}}
  		<b style="color:blue;">
  	{{/if}}
  	{{tick}} ({{b.x}})
  	{{#if rendered}}
  		</b>
  	{{/if}}
  	</div>
  {{/each}}

</script>

	<script type="text/javascript">

	

		    var W = window.innerWidth;



	
	
       window.onresize = function(){
               W = window.innerWidth;               
       };

	(function(){
		var worldBuffer = [];
	    var worldBufferIndex = -1;
	    var clientTick = 0;
	    var serverTick;
	    var serverLag = 0;
	    var clientTime = new Date().getTime();
	    var el = document.getElementById('debug');
	   
	   var bEl = document.getElementById('ball');
	    var firstTick;
	    var firstTickTime;

	    var source   = document.getElementById("entry-template").innerHTML;
		var template = Handlebars.compile(source);

		var socket = io.connect(
			'http://'+window.location.hostname+':9000/'
		);

		socket.on('connect', function () {});


		socket.on('w', function(data){
			serverTick = data.tick;
			worldBufferIndex++;

			if(worldBufferIndex > 30){
				worldBufferIndex = 0;
			}

			worldBuffer[worldBufferIndex] = data;
			
			if(!firstTick) {
				firstTick = data.tick;
				firstTickTime = new Date().getTime().toString().substring(0,11);
				requestAnimationFrame(start);
			}
			
		});

		function start(){
			var toRender = null;
			var debug = {};

			var currentTime = new Date().getTime().toString().substring(0,11);
			debug.currentTime = currentTime;

			var timeSincefirstTick = ((currentTime - 10) - firstTickTime); 
			debug.timeSincefirstTick = timeSincefirstTick;
			debug.firstTick = firstTick;
			debug.firstTickTime = firstTickTime;

			var tickNo = Math.floor((timeSincefirstTick) + firstTick);
			
			if(tickNo > serverTick) tickNo = serverTick;

			debug.tickNo = tickNo;
			debug.serverTick = serverTick;
			debug.tickBehind = serverTick - tickNo;
			toRender = _.find(worldBuffer, function(world){ return world.tick == tickNo; });
			
			if(toRender) {
				toRender.rendered = true;
				bEl.style.left = ((toRender.b.x / 100) * W) + "px";
				
			}

			el.innerHTML = template({'buffer' : worldBuffer, 'debug': JSON.stringify(debug)});
			
			requestAnimationFrame(start);
		}

	})();

	</script>
	</body>
</html>
